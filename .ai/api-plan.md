# REST API Plan

## 1. Resources

- **Users**: Maps to the `users` table. Contains user information such as email, encrypted_password, created_at, and managed by Supabase Auth.
- **Flashcards**: Maps to the `flashcards` table. Represents individual flashcards with fields like front, back, source, and associations to users and generations. Validation includes max lengths (front: 200, back: 500) and allowed source values.
- **Generations**: Maps to the `generations` table. Stores metadata about AI-generated flashcard sessions, including counts of generated and accepted flashcards, model used, source text hash, and duration.
- **Generation Logs**: Maps to the `generation_logs` table. Records logging details including error codes and messages during flashcard generation.

## 2. Endpoints

<!-- ### 2.1 User Endpoints (Commented Out for Future Implementation)
- **POST /api/users/register**
  - Description: Register a new user.
  - Request JSON Payload:
    ```json
    {
      "email": "string",
      "password": "string"
    }
    ```
  - Response:
    - 201 Created:
      ```json
      {
         "id": "uuid",
         "email": "string",
         "created_at": "ISO8601 timestamp"
      }
      ```
    - 400 Bad Request:
      ```json
      { "error": "Invalid input" }
      ```
- **POST /api/users/login**
  - Description: Authenticate a user and return a JWT token.
  - Request JSON Payload:
    ```json
    {
      "email": "string",
      "password": "string"
    }
    ```
  - Response:
    - 200 OK:
      ```json
      {
         "token": "JWT token",
         "user": {
             "id": "uuid",
             "email": "string"
         }
      }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Unauthorized" }
      ```
- **DELETE /api/users**
  - Description: Delete a user account along with all associated flashcards and data.
  - Response:
    - 204 No Content
--> 

### 2.2 Flashcard Endpoints

- **GET /api/flashcards**
  - Description: Retrieve a paginated list of flashcards for the authenticated user. Supports optional filters for `source` and `generation_id`.
  - Query Parameters:
    - page: number (default 1)
    - limit: number (default 10)
    - sort: string (e.g., 'created_at')
    - source (optional): string (e.g., 'ai-full', 'ai-edited', 'manual')
    - generation_id (optional): UUID
  - Response:
    - 200 OK:
      ```json
      {
         "data": [
            {
               "id": "uuid",
               "front": "What is AI?",
               "back": "Artificial Intelligence",
               "source": "ai-full",
               "user_id": "uuid",
               "generation_id": "uuid",
               "created_at": "2023-10-10T12:34:56Z"
            }
         ],
         "pagination": {
            "page": 1,
            "limit": 10,
            "total_pages": 5,
            "total_items": 45
         }
      }
      ```
    - 400 Bad Request:
      ```json
      { "error": "Invalid query parameters" }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

- **GET /api/flashcards/{id}**
  - Description: Retrieve details of a specific flashcard by its ID.
  - Response:
    - 200 OK:
      ```json
      {
         "id": "uuid",
         "front": "What is AI?",
         "back": "Artificial Intelligence",
         "source": "ai-full",
         "user_id": "uuid",
         "generation_id": "uuid",
         "created_at": "2023-10-10T12:34:56Z"
      }
      ```
    - 404 Not Found:
      ```json
      { "error": "Flashcard not found" }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

- **POST /api/flashcards**
  - Description: Create new flashcards. Supports creating multiple flashcards simultaneously, including those generated by AI (source 'ai-full' or 'ai-edited') and manual entries.
  - Request JSON Payload:
    ```json
    {
       "flashcards": [
          {
             "front": "What is AI?",
             "back": "Artificial Intelligence",
             "source": "manual",
             "generation_id": null

          },
          {
             "front": "Define ML",
             "back": "Machine Learning",
             "source": "ai-full",
            "generation_id": "081df36e-65e0-4232-b55e-75baff797a77"

          }
       ]
    }
    ```
  - Response:
    - 201 Created:
      ```json
      {
         "data": [
            {
               "id": "uuid1",
               "front": "What is AI?",
               "back": "Artificial Intelligence",
               "source": "manual",
               "created_at": "2023-10-10T12:34:56Z",
               "generation_id": null
            },
            {
               "id": "uuid2",
               "front": "Define ML",
               "back": "Machine Learning",
               "source": "ai-full",
               "created_at": "2023-10-10T12:35:00Z",
               "generation_id": "081df36e-65e0-4232-b55e-75baff797a77"

            }
         ]
      }
      ```
    - 400 Bad Request:
      ```json
      { "error": "Invalid flashcard data" }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

- **PUT /api/flashcards/{id}**
  - Description: Update an existing flashcard. If updating the `source`, it must be either 'ai-edited' or 'manual'.
  - Request JSON Payload:
    ```json
    {
       "front": "Updated question",
       "back": "Updated answer",
       "source": "ai-edited"
    }
    ```
  - Response:
    - 200 OK:
      ```json
      {
         "id": "uuid",
         "front": "Updated question",
         "back": "Updated answer",
         "source": "ai-edited",
         "updated_at": "2023-10-10T13:00:00Z"
      }
      ```
    - 400 Bad Request:
      ```json
      { "error": "Invalid update data or invalid source value" }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 404 Not Found:
      ```json
      { "error": "Flashcard not found" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

- **DELETE /api/flashcards/{id}**
  - Description: Delete a flashcard by its ID.
  - Response:
    - 204 No Content (no response body)
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 404 Not Found:
      ```json
      { "error": "Flashcard not found" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

### 2.3 Generation Endpoints

- **GET /api/generations**
  - Description: List flashcard generation sessions for the authenticated user.
  - Query Parameters:
    - page: number (default 1)
    - limit: number (default 10)
    - sort: string (e.g., 'created_at')
  - Response:
    - 200 OK:
      ```json
      {
         "data": [
            {
               "id": "uuid",
               "user_id": "uuid",
               "model": "openai",
               "generated_count": 10,
               "accepted_unedited_count": 5,
               "accepted_edited_count": 3,
               "source_text_hash": "hash",
               "source_text_length": 2000,
               "duration": 120,
               "created_at": "2023-10-10T12:00:00Z"
            }
         ],
         "pagination": {
            "page": 1,
            "limit": 10,
            "total_pages": 2,
            "total_items": 15
         }
      }
      ```
    - 400 Bad Request:
      ```json
      { "error": "Invalid query parameters" }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

- **GET /api/generations/{id}**
  - Description: Retrieve details for a single generation session.
  - Response:
    - 200 OK:
      ```json
      {
         "id": "uuid",
         "user_id": "uuid",
         "model": "openai",
         "generated_count": 10,
         "accepted_unedited_count": 5,
         "accepted_edited_count": 3,
         "source_text_hash": "hash",
         "source_text_length": 2000,
         "duration": 120,
         "created_at": "2023-10-10T12:00:00Z"
      }
      ```
    - 404 Not Found:
      ```json
      { "error": "Generation session not found" }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

- **POST /api/generate**
  - Description: Generate flashcard suggestions using an AI model based on provided input text.
  - Request JSON Payload:
    ```json
    {
       "text": "A lengthy input text (between 1000 and 10000 characters)..."
    }
    ```
  - Response:
    - 200 OK:
      ```json
      {
        "generation_id": "cba35944-71cc-40ad-a9c2-aeb08632d280"
         "data": [
            {
               "front": "Generated Question 1",
               "back": "Generated Answer 1",
               "source": "ai-full"
            },
            {
               "front": "Generated Question 2",
               "back": "Generated Answer 2",
               "source": "ai-full"
            }
         ],
         "generated_count": 5
      }
      ```
    - 400 Bad Request:
      ```json
      { "error": "Invalid input text" }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

### 2.4 Generation Logs Endpoints

- **GET /api/generation-logs**
  - Description: Retrieve generation logs for the authenticated user. Access is restricted to admin users; non-admin users receive a 403 Forbidden.
  - Query Parameters:
    - page: number (default 1)
    - limit: number (default 10)
  - Response:
    - 200 OK (for admin users):
    - 403 Forbidden (for non-admin users):
      ```json
      { "error": "Forbidden: Admin access required" }
      ```
    - 401 Unauthorized:
      ```json
      { "error": "Authentication required" }
      ```
    - 500 Internal Server Error:
      ```json
      { "error": "Server error" }
      ```

## 3. Authentication and Authorization

- The API uses JWT token-based authentication, integrated with Supabase Auth.
- Endpoints are secured so that only authenticated users can access and modify their own data.
- Row Level Security (RLS) is enforced at the database level to ensure each user accesses only their assigned records.
- Protected endpoints for creating, updating, and deleting resources require a valid token and a matching user ID with the resource owner.

## 4. Validation and Business Logic

- **Input Validation:**
  - For flashcards:
    - `front`: Must not exceed 200 characters.
    - `back`: Must not exceed 500 characters.
    - `source`: For creation endpoints, must be one of 'ai-full', 'ai-edited', or 'manual'. For updates via PUT, if `source` is provided, it must be either 'ai-edited' or 'manual'.
  - For generations:
    - `source_text_length`: Must be between 1000 and 15000 characters.
- **Business Logic:**
  - **Automatic Flashcard Generation:** When a user sends text via POST /api/generate, the API calls an external AI service (using Openrouter.ai) to generate flashcard suggestions. Successful generations update the `generations` table with generation counts and session details.
  - **Review and Approval:** Users review generated flashcards and can choose to accept, modify, or reject them before they are saved permanently.
  - **Manual CRUD Operations:** Standard create, read, update, and delete operations allow users to manage flashcards manually.
  - **Study Session Management:** Although not fully implemented in the MVP, a future endpoint (e.g., GET /api/flashcards/review) may be added to support spaced repetition learning sessions.
- **Error Handling:**
  - Endpoints return appropriate HTTP status codes:
    - 200 OK for successful retrieval or update.
    - 201 Created for successful creation.
    - 400 Bad Request for validation errors.
    - 401 Unauthorized for authentication failures.
    - 403 Forbidden for access restrictions (e.g., non-admin access to logs).
    - 404 Not Found when a resource is not found.
    - 500 Internal Server Error for server-side issues.

## Assumptions

- User authentication flows (registration and login) are handled by Supabase Auth. The API integrates with these flows to obtain user tokens and enforce RLS at the database level.
- Rate limiting, caching, and pagination are handled at the API gateway or server level to ensure performance and security.
- The frontend (built using Astro with React) will manage user interactions and consume these endpoints using JSON payloads. 